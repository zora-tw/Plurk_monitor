name: Clean Old Workflow Runs

on:
  schedule:
    - cron: '0 * * * *'  # 每小時的第 0 分鐘執行（整點）
  workflow_dispatch:      # 可手動觸發

jobs:
  delete-old-runs:
    runs-on: ubuntu-latest

    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const cleanupWorkflows = [
              { name: 'check_plurk.yml', keep: 1 },
              { name: 'clean-workflows.yml', keep: 3 },
            ];

            for (const { name, keep } of cleanupWorkflows) {
              console.log(`處理 workflow: ${name}，保留最新 ${keep} 筆`);

              try {
                const { data: runs } = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: name,
                  per_page: 100,
                });

                if (runs.total_count <= keep) {
                  console.log(`${name} 沒有多餘的 workflow runs，略過刪除。`);
                  continue;
                }

                const oldRuns = runs.workflow_runs.slice(keep);

                for (const run of oldRuns) {
                  console.log(`刪除 ${name} 的 Run #${run.run_number} (${run.id})`);
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                }

              } catch (error) {
                console.error(`無法處理 ${name}：${error.message}`);
              }
            }
