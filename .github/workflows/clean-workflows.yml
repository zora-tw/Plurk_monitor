name: Clean Old Workflow Runs

on:
  schedule:
    - cron: '49 * * * *'  # æ¯å°æ™‚çš„ç¬¬ 49 åˆ†é˜åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ï¼‰
  workflow_dispatch:

jobs:
  delete-old-runs:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸŒ Set timezone to Asia/Taipei
        run: sudo ln -sf /usr/share/zoneinfo/Asia/Taipei /etc/localtime

      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const cleanupWorkflows = [
              { name: 'check_plurk.yml', keep: 3 },
              { name: 'clean-workflows.yml', keep: 3 },
            ];

            for (const { name, keep } of cleanupWorkflows) {
              console.log(`è™•ç† workflow: ${name}ï¼Œä¿ç•™æœ€æ–° ${keep} ç­†`);

              try {
                const { data: runs } = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: name,
                  per_page: 100,
                });

                if (runs.total_count <= keep) {
                  console.log(`${name} æ²’æœ‰å¤šé¤˜çš„ workflow runsï¼Œç•¥éåˆªé™¤ã€‚`);
                  continue;
                }

                const oldRuns = runs.workflow_runs.slice(keep);

                for (const run of oldRuns) {
                  console.log(`åˆªé™¤ ${name} çš„ Run #${run.run_number} (${run.id})`);
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                }

              } catch (error) {
                console.error(`ç„¡æ³•è™•ç† ${name}ï¼š${error.message}`);
              }
            }
